<?php

/**
 * Implements hook_toolbar().
 */
function civicrm_toolbar() {
  $items = array();

  // Initialize civicrm
  $civicrm = \Drupal::service('civicrm');
  $navigationTree = $civicrm->navigationTree();

  $items['civicrm'] = array(
    '#type' => 'toolbar_item',
    'tab' => array(
      '#type' => 'link',
      '#title' => t('CiviCRM'),
      '#href' => 'civicrm.civicrm',
      '#options' => array(
        'attributes' => array(
          'title' => t('CiviCRM'),
          'class' => array('toolbar-icon', 'toolbar-icon-home'),
        ),
      ),
    ),
    'tray' => array(
      '#heading' => t('CiviCRM menu'),
      'civicrm_toolbar' => array(
        '#type' => 'container',
        '#attributes' => array(
          'class' => array('civicrm-toolbar-menu'),
        ),
        'civicrm_menu' => array(
          '#theme_wrappers' => array('menu_tree'),
        ),
      ),
    ),
    '#weight' => 0,
    '#attached' => array(
      'js' => array(
        'jQuery(function() { jQuery("#toolbar-administration .civicrm-toolbar-menu ul.menu").drupalToolbarMenu(); });' => array('type' => 'inline'),
      ),
    ),
  );

  foreach ($navigationTree as $leaf) {
    _civicrm_toolbar($items['civicrm']['tray']['civicrm_toolbar']['civicrm_menu'], $leaf);
  }

  return $items;
}

/**
 * Recursive helper function for building the toolbar menu.
 *
 * @param $items
 * @param $leaf
 *
 * @Todo Remove links from placeholder menu items (eg. menu headings).
 */
function _civicrm_toolbar(&$items, $leaf) {
  $item = array(
    '#theme' => 'menu_link',
    '#title' => $leaf['attributes']['label'],
    '#href' => $leaf['attributes']['url'],
    '#localized_options' => array('query' => $leaf['attributes']['query']),
    '#below' => array(),
    '#attributes' => array(
      'class' => array('collapsed'),
    ),
  );

  if (is_array($leaf['child'])) {
    foreach ($leaf['child'] as $child) {
      _civicrm_toolbar($item['#below'], $child);
    }
    $item['#below']['#theme_wrappers'] = array('menu_tree');
  }

  $items[] = $item;
}
